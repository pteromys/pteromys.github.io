<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">

<head>
 <title>Molar Mass Calculator</title>
 <style type="text/css">
  body {background:#99CCFF; font-family:sans-serif; font-size:small;}
  h1 {text-align:center;}

  table {
   border-style:solid; border-width:5px;
   border-color:#006600; background:#66CC66;
   margin:auto; border-spacing:0.5em;
  }
  td {
   border-style:solid; border-width:1px;
   border-color:#009900; background:#CCFFCC;
   padding:0.5em;
  }

  .td-ghost {
   border-width:0px; padding:0px; margin:1em;
   background:inherit;
  }
  .text-in {
   background:#FFFFCC; border-color:#999900;
   border-style:solid; border-width:1px;
   padding:0.5em;
  }

  .intropar {text-align:center; margin-bottom:1em;}
  .notice {font-weight:bold; color:#FF0000;}
  
  .introbox {
   background:#ccff99;
   border-color:#336633 #66cc66 #66cc66 #336633;
   border-width:2px; border-style:solid;
   padding:0.5em; overflow:auto;
   width:32em; height:10em;
   margin-left:auto; margin-right:auto; margin-bottom:1em;
  }
  .para {text-indent:2em;}
 </style>


 <script type="text/javascript">
  <!--
   chc_name = new String(
   	"    "+
	"H   "+														"He  "+
	"Li  "+		"Be  "+		"B   "+		"C   "+		"N   "+		"O   "+		"F   "+		"Ne  "+
	"Na  "+		"Mg  "+		"Al  "+		"Si  "+		"P   "+		"S   "+		"Cl  "+		"Ar  "+
	"K   "+		"Ca  "+
		"Sc  "+		"Ti  "+		"V   "+		"Cr  "+		"Mn  "+		"Fe  "+		"Co  "+		"Ni  "+		"Cu  "+		"Zn  "+
					"Ga  "+		"Ge  "+		"As  "+		"Se  "+		"Br  "+		"Kr  "+
	"Rb  "+		"Sr  "+
		"Y   "+		"Zr  "+		"Nb  "+		"Mo  "+		"Tc  "+		"Ru  "+		"Rh  "+		"Pd  "+		"Ag  "+		"Cd  "+
					"In  "+		"Sn  "+		"Sb  "+		"Te  "+		"I   "+		"Xe  "+
	"Cs  "+		"Ba  "+
		"La  "+		"Ce  "+		"Pr  "+		"Nd  "+		"Pm  "+		"Sm  "+		"Eu  "+		"Gd  "+		"Tb  "+		"Dy  "+		"Ho  "+		"Er  "+		"Tm  "+		"Yb  "+
		"Lu  "+		"Hf  "+		"Ta  "+		"W   "+		"Re  "+		"Os  "+		"Ir  "+		"Pt  "+		"Au  "+		"Hg  "+
					"Tl  "+		"Pb  "+		"Bi  "+		"Po  "+		"At  "+		"Rn  "+
	"Fr  "+		"Ra  "+
		"Ac  "+		"Th  "+		"Pa  "+		"U   "+		"Np  "+		"Pu  "+		"Am  "+		"Cm  "+		"Bk  "+		"Cf  "+		"Es  "+		"Fm  "+		"Md  "+		"No  "+
		"Lr  "+		"Rf  "+		"Db  "+		"Sg  "+		"Bh  "+		"Hs  "+		"Mt  "+		"Ds  "+		"Rg  "+		"Uub "+
					"Uut "+		"Uuq "+		"Uup "+		"Uuh "+		"Uus "+		"Uuo "
   );
   chc_mass = new Array(
   	0,
	1.00794,													4.002602,	// He
	6.941,		9.01218,	10.811,		12.0107,	14.00674,	15.9994,	18.998403,	20.1797,	// Ne
	22.989768,	24.305,		26.981539,	28.0855,	30.973762,	32.065,		35.4527,	39.948,		// Ar
	39.0983,	40.078,
		44.95591,	47.867,		50.9415,	51.9961,	54.93805,	55.847,		58.9332,	58.6934,	63.546,		65.39,
					69.723,		72.64,		74.92159,	78.96,		79.904,		83.8,		// Kr
	85.4678,	87.62,
		88.90585,	91.224,		92.90638,	95.94,		98,		101.07,		102.9055,	106.42,		107.8682,	112.411,
					114.818,	118.71,		121.760,	127.6,		126.90447,	131.293,	// Xe
	132.90543,	137.327,
		138.9055,	140.116,	140.90765,	144.24,		145,		150.36,		151.964,	157.25,		158.92534,	162.50,		164.93032,	167.259,	168.93421,	173.04,
		174.967,	178.49,		180.9479,	183.84,		186.207,	190.23,		192.217,	195.078,	196.96654,	200.59,
					204.3833,	207.2,		208.98037,	209,		210,		222,		// Rn
	223,		226,
		227,		232.0381,	231.03588,	238.0289,	237,		244,		243,		247,		247,		251,		252,		257,		258,		259,
		262,		261,		262,		266,		264,		269,		268,		271,		272,		285,
					284,		289,		288,		292,		NaN,		NaN		//Uuo
   );
   chc_decs = new Array(
   	0,
	5,														6,		// He
	3,		5,		3,		4,		5,		4,		6,		4,		// Ne
	6,		3,		6,		4,		6,		3,		4,		3,		// Ar
	4,		3,
		5,		3,		4,		4,		5,		3,		4,		4,		3,		2,
					3,		2,		5,		2,		3,		1,		// Kr
	4,		2,
		5,		3,		5,		2,		0,		2,		4,		2,		4,		3,
					3,		2,		3,		1,		5,		3,		// Xe
	5,		3,
		4,		3,		5,		2,		0,		2,		3,		2,		5,		2,		5,		3,		5,		2,
		3,		2,		4,		2,		3,		2,		3,		3,		5,		2,
					4,		1,		5,		0,		0,		0,		// Rn
	0,		0,
		0,		4,		5,		4,		0,		0,		0,		0,		0,		0,		0,		0,		0,		0,
		0,		0,		0,		0,		0,		0,		0,		0,		0,		0,
					0,		0,		0,		0,		0,		0		//Uuo
   );
   chc_un	= new String("nubtqphsoe");	//Nil, Un, Bi, Tri, Quad, Pent, Hex, Sept, Oct, Enn
   chc_unc	= new String("NUBTQPHSOE");	//caps
   
   chmatch      = /[A-Z][a-z]{0,2}[0-9]*/g;
   chmatch_name	= /[A-Z][a-z]{0,2}/g;
   
   chmatch_grp	= /\([^\(\)]*\)[0-9]*/;
   chmatch_gin  = /\([^\(\)]*\)/;
   chmatch_num  = /([^\*0-9])[0-9]+/;
   chmatch_ng   = /([^\*0-9])[0-9]+/g;
   
   function cleanup() {
    delete instr;
    delete chblock;
    delete chlist;
    delete chcount;
   }
   
   function showerr(emessage) {
    document.getElementById("chans").innerHTML = "<span class='notice'>" + emessage + "</span>";
    return 0;
   }
   
   function is_radioactive(atomnum) {
    if(atomnum==43 || atomnum==61) {return true;}
    if(atomnum>=84 && atomnum<=89) {return true;}
    if(atomnum>=93) {return true;}
    return false;
   }
   
   function getcount(stringtomatch, exptomatch) {
    var retval = stringtomatch.match(exptomatch);
    if(retval) {return retval.length;}
    return 0;
   }
   
   function chparse() {
    // Prepare variables
    var chsum = 0;	// answer
    var chdecs = 100;	// num of sig figs past decimal point
    var chrad = 0;	// radioactivity
    var chswri = "";	// string to be written
    
    var thisgroup;	// string of elements for current group
    var thisgmult;	// multiplier for the group
    var numpars;	// number of parentheses
    var numnums;	// number of numbers to alter in this group
    
    var thisname;	// name part of current element block
    var thisnum;	// number part of current element block
    var thisprot;	// current atomic number
    var eunknown;	// whether the current element is unrecognized
   
    // Reset the work space
    document.getElementById("chtotals").innerHTML = "";
    
    // Get input
    instr   = new String(document.getElementById("chformula").value);

    // Make sure the input actually has elements
    if(getcount(instr, chmatch) == 0) {
     showerr("Error: No recognized elements");
     return 0;
    }
    
    // Make sure the input has matched parentheses
    if(getcount(instr, /\(/g) != getcount(instr, /\)/g)) {
     showerr("Error: Mismatched parentheses");
     return 0;
    }
    
    // Trivial preprocessing that makes later parsing much easier
    instr = instr.replace(/([A-Z][a-z]{2})[a-z]+/g, "$1");		// Shorten all elements down to three letters
    instr = instr.replace(/([A-Z][a-z]{0,2})(?![a-z0-9])/g, "$11");	// Insert ones where they might have been omitted
    instr = instr.replace(/[A-Z][a-z]{0,2}0+(?![0-9])/g, "");		// Remove elements with zero count
    instr = instr.replace(/\([^\(\)]*\)0+(?![0-9])/g, "");		// Remove groups with zero count
    instr = instr.replace(/\(\)[0-9]*/g,"");				// Remove empty groups
    instr = instr.replace(/([^0-9])0+/g, "$1");				// Then strip leading zeros to avoid parsing numbers as octals
    
    // Parse parenthesized groups
    numpars = getcount(instr, /\(/g);
    for(var ix = 0; ix<numpars; ix++) {
     thisgroup = instr.match(chmatch_grp)[0];			// Get next group
     thisgmult = thisgroup.replace(chmatch_gin, "");		// Fetch multiplier
     if(thisgmult == "") {thisgmult = "1";}
     thisgmult = eval(thisgmult);
     
     thisgroup = thisgroup.match(chmatch_gin)[0];		// Remove the number
     thisgroup = thisgroup.substr(1,thisgroup.length-2);	// Remove parentheses
     numnums = getcount(thisgroup, chmatch_ng);		// Find out how many numbers to replace
     for(var iy = 0; iy<numnums; iy++) {
      thisnum = eval(thisgroup.match(chmatch_num)[0].substr(1));
      thisnum = thisnum*thisgmult;
      thisgroup = thisgroup.replace(chmatch_num, "$1*" + thisnum);	// Flag it so it isn't caught the next iteration
     }
     thisgroup = thisgroup.replace(/\*/g, "");				// Cut off the flags
     instr = instr.replace(chmatch_grp, thisgroup);
    }
    document.getElementById("chostr").innerHTML = instr;

    // Sort the string into individually handled blocks
    chblock = (instr.match(chmatch)).sort();
    chlist  = new Array();
    chcount = new Array();

    //-----
    
    // Organize a list of elements and their quantities
    for(var ix=0; ix<chblock.length; ix++) {
     thisname = (chblock[ix].match(chmatch_name))[0];	// Get just the name from the block
     if( (chlist.length == 0)  ||  (thisname != chlist[chlist.length - 1]) ) {
      chlist[chlist.length] = thisname;			// If we're on a new element, switch to the next list item.
      chcount[chcount.length] = 0;
     }
     thisnum = chblock[ix].replace(chmatch_name,"");
     chcount[chcount.length - 1] += eval(thisnum);	// Add to the total count for this element
    }
    
    // Total up the masses
    for(var ix=0; ix<chcount.length; ix++) {
     // Get atomic number
     thisprot = chc_name.indexOf(chlist[ix] + " ")/4;

     // Match not found? Try to parse Greek number.
     if(thisprot<1) {
      eunknown = 1;
      if(chlist[ix].length == 3) {
       if((chc_unc.indexOf(chlist[ix].substr(0,1))>=0) && (chc_un.indexOf(chlist[ix].substr(1,1))>=0) && (chc_un.indexOf(chlist[ix].substr(2,1))>=0)) {
        thisprot = 100*chc_unc.indexOf(chlist[ix].substr(0,1));
        thisprot += 10*chc_un.indexOf(chlist[ix].substr(1,1));
        thisprot +=  1*chc_un.indexOf(chlist[ix].substr(2,1));
        if(thisprot<=118) {eunknown = 0;}
       }
      }
      
      // Still no match? Give up.
      if(eunknown) {
       showerr("Error: '" + chlist[ix] + "' is not a recognized element");
       cleanup();
       return 0;
      }
     }
     
     if(thisprot>=117) {
      showerr("Error: The mass of '" + chlist[ix] + "' is unknown");
      cleanup();
      return 0;
     }
     
     // Show totals
     document.getElementById("chtotals").innerHTML = document.getElementById("chtotals").innerHTML +
      chlist[ix] + " &times; " + chcount[ix] + " : " + chc_mass[thisprot]*chcount[ix] + "<br />";
     chsum += chc_mass[thisprot]*chcount[ix];				// Add the mass to the total
     if(chc_decs[thisprot] < chdecs) {chdecs = chc_decs[thisprot];}	// Sig fig check
     if(is_radioactive(thisprot)) {chrad = 1;}				// Radioactivity check
    }
    
    // Round the answer
    chswri = String(( Math.round(chsum * Math.pow(10,chdecs)) + 0.1) / Math.pow(10,chdecs) );
    chswri = chswri.substr(0, chswri.indexOf(".") + 1 + chdecs - ( (chdecs==0) && (chswri.substr(chswri.indexOf(".") - 1, 1)!=0) ));
    	// "( (chdecs==0) && (chswri.substr(chswri.indexOf(".") - 1, 1)!=0) )" needs some explaining
	// 1. (chdecs==0) evaluates to 1 if the answer is a whole number, 0 otherwise. Removes the decimal point when the answer is whole.
	// 2. (chswri.substr(chswri.indexOf(".") - 1, 1)!=0) evaluates to 0 if the digit before the decimal is zero.
	//	Keeps the decimal from being removed when it's needed to show sig figs.

    // Radioactivity
    if(chrad) {chswri = chswri + " <span class='notice'>(Contains unstable elements)</span>"}
    
    // Show the answer
    document.getElementById("chans").innerHTML = chswri;
    
    // Clean up and exit
    cleanup();
    return 0;
   }
  //-->
 </script>
</head>


<body>
 <h1>Molar Mass Calculator</h1>

 <div class="introbox">
  <div class="para">If you enter a molecular formula (case-sensitive) in the box, this script will try to calculate its molar mass (in grams per mole).</div>
  <div class="para">Several recently named elements can be referred to by their "unnamed" symbols (for example, "Mt" [Meitnerium] and "Une" [Unnilennium] both refer to element 109).</div>
  <div class="para">To calculate the mass of a hydrate, rewrite it like this:</div>
  <div style="text-align:center;">CuSO4 &middot; 5H2O &rArr; CuSO4 (H2O)5 </div>
  <div style="text-align:right;"><i>Copyright &copy; 2005 by Andrew Geng</i></div>
 </div>

 <form action="#" method="get" onsubmit="chparse();return false;">
  <table>
   <tr>
    <td style="text-align:center;" title="Case sensitive. Type subscripts as regular numbers.">Molecular formula</td>
    <td class="td-ghost"><input type="text" size="60" class="text-in" id="chformula" value="H2O" /></td>
   </tr>
   <tr>
    <td class="td-ghost" colspan="2" style="text-align:center;">
     <input id="gobutton" type="button" value="Get Molar Mass" onclick="chparse();" />
    </td>
   </tr>
   <tr>
    <td>Processed formula</td>
    <td><span id="chostr"></span></td>
   </tr>
   <tr>
    <td>Element totals</td>
    <td><span id="chtotals"></span></td>
   </tr>
   <tr>
    <td>Molar Mass</td>
    <td><span id="chans"></span></td>
   </tr>
  </table>
 </form>

</body>

</html>
